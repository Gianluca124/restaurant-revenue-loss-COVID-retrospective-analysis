---
title: "TSCrossValidation-Summary"
author: "Carbone Giorgio"
date: "2022-12-16"
output:
  prettydoc::html_pretty:
    df_print: paged
    highlight: vignette
    theme: architect
    toc: yes
    toc_depth: 5
  beamer_presentation:
    colortheme: lily
    fig_caption: no
    fig_height: 6
    fig_width: 7
    fonttheme: structurebold
    theme: Hannover
    toc: yes
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
  pdf_document:
    toc: yes
    toc_depth: 5
  slidy_presentation:
    highlight: default
  ioslides_presentation:
    css:
    - css/fonts.css
    - css/custom.css
    - css/title-slide.css
    - css/slide-background.css
    includes:
      before_body: html/TimeSeriesAnalysis.html
    toc: yes
    transition: default
    widescreen: yes
course: Progetto Data Science Lab
---

# Setup

```{r}
# Clean Workspace
rm(list=ls())
```

```{r setup, include=FALSE}
# Use 'verbatim = TRUE' as chunk option to show chunk code as is
require(knitr)
hook_source_def = knit_hooks$get('source')
knit_hooks$set(source = function(x, options){
  if (!is.null(options$verbatim) && options$verbatim){
    opts = gsub(",\\s*verbatim\\s*=\\s*TRUE\\s*", "", options$params.src)
    bef = sprintf('\n\n    ```{r %s}\n', opts, "\n")
    stringr::str_c(bef, paste(knitr:::indent_block(x, "    "), collapse = '\n'), "\n    ```\n")
  } else {
     hook_source_def(x, options)
  }
})
```

## Loading Libraries and Functions

```{r include=FALSE}
set.seed(100)

# Setting librerie utili
# Package names
packages <- c("readxl",  "readr", "forecast", "dplyr", "ggplot2",
              "lubridate", "KFAS", "tseries", "xts", "fastDummies", "TSstudio", "utils") 

# Install packages if not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))
```

```{r}
source("My-TSCrossValidation-Functions.R")
```


# Pre Covid

## Load Errors

Errori assoluti 

```{r message=FALSE, warning=FALSE}
working_dir = dirname(rstudioapi::getSourceEditorContext()$path)
setwd(working_dir) # lo applica solo a questo chunk!

h = 73
folder_path <- "./Errors"
error_df_list_precovid <- list()


# Lista dei tipi di modelli
items <- list.files(folder_path, recursive = FALSE, full.names = TRUE)

for (dir in items) {
  csv_files <- list.files(path = dir, pattern = "*.csv", full.names = TRUE)
  filtered_csv_files <- csv_files %>% grep("PreCovid_e[0-9]+\\.csv$", ., value = TRUE)
  for (f in filtered_csv_files) {
    df <- read_csv(f)
    #df$date  <- parse_date(df$date, "%Y-%m-%d", locale = locale("it"))
    
    # Tolgo prima, seconda e ultima (h=74) colonne
    df <- xts(df[, c(-1,-2, -ncol(df))], as.Date(as.character(df$date), format = "%Y-%m-%d"))
    colnames(df) <- paste("h=", 1:h, sep = "")
    
    
    var_name <- gsub("\\.csv$", "", basename(f))
    assign(var_name, df)
    
    # Aggiungo alla lista
    error_df_list_precovid[[var_name]] <- df
  }
}
```

Errori percentuali

```{r message=FALSE, warning=FALSE}
working_dir = dirname(rstudioapi::getSourceEditorContext()$path)
setwd(working_dir) # lo applica solo a questo chunk!

h = 73
folder_path <- "./Errors"
error_percentage_df_list_precovid <- list()


# Lista dei tipi di modelli
items <- list.files(folder_path, recursive = FALSE, full.names = TRUE)

for (dir in items) {
  csv_files <- list.files(path = dir, pattern = "*.csv", full.names = TRUE)
  filtered_csv_files <- csv_files %>% grep("PreCovid_e[0-9]+_percentage\\.csv$", ., value = TRUE)
  for (f in filtered_csv_files) {
    df <- read_csv(f)
    #df$date  <- parse_date(df$date, "%Y-%m-%d", locale = locale("it"))
    
    df <- xts(df[, c(-1,-2, -ncol(df))], as.Date(as.character(df$date), format = "%Y-%m-%d"))
    colnames(df) <- paste("h=", 1:h, sep = "")
    
    
    var_name <- gsub("\\.csv$", "", basename(f))
    assign(var_name, df)
    
    # Aggiungo alla lista
    error_percentage_df_list_precovid[[var_name]] <- df
  }
}
```

### RMSE

```{r}
RMSE_PreCovid <- list()

for (df_name in names(error_df_list_precovid)) {
  # Accedi al dataframe nella lista utilizzando il suo nome
  df <- error_df_list_precovid[[df_name]]
  
  # Applica la funzione di tua scelta al dataframe
  result <- sqrt(colMeans(df^2, na.rm = TRUE))
  
  # Assegna il risultato a una variabile con il nome "RMSE_nomedeldataframe"
  result_name <- paste0("RMSE_", df_name)
  
  RMSE_PreCovid[[result_name]] <- result
}
```


```{r}
i_x = 0
f_x = 73
by_x = 10

i_y = 2000
f_y = 6000
by_y = 1000

ylab = "RMSE"
accuracy_metrics = RMSE_PreCovid

model_types = "ARIMA|UCM|RandomForest"

pre_covid_accuracy_plot(i_x, f_x, by_x, i_y, f_y, by_y, ylab, model_types, accuracy_metrics)

```

Valori medi
```{r}
lapply(RMSE_PreCovid, mean)
```

#### RMSE hold-out 

```{r}
RMSE_PreCovid_holdout <- list()

for (df_name in names(error_df_list_precovid)) {
  # Accedi al dataframe nella lista utilizzando il suo nome
  df <- error_df_list_precovid[[df_name]]
  
  # Applica la funzione di tua scelta al dataframe
  result <- sqrt(rowMeans(df["2019-12-12", ]^2, na.rm = TRUE))
  
  # Assegna il risultato a una variabile con il nome "RMSE_nomedeldataframe"
  result_name <- paste0("RMSE_", df_name)
  
  RMSE_PreCovid_holdout[[result_name]] <- result
}

RMSE_PreCovid_holdout
```


### RMdSE

```{r}
library(robustbase)
RMdSE_PreCovid <- list()

for (df_name in names(error_df_list_precovid)) {
  # Accedi al dataframe nella lista utilizzando il suo nome
  df <- error_df_list_precovid[[df_name]]
  
  # Applica la funzione di tua scelta al dataframe
  result <- sqrt(colMedians(df^2, na.rm = TRUE, hasNA = TRUE))
  
  # Assegna il risultato a una variabile con il nome "RMSE_nomedeldataframe"
  result_name <- paste0("RMdSE_", df_name)
  
  RMdSE_PreCovid[[result_name]] <- result
}
```

```{r}
i_x = 0
f_x = 74
by_x = 10

i_y = 1000
f_y = 4000
by_y = 200
ylab = "RMdSE"
accuracy_metrics = RMdSE_PreCovid

model_types = "ARIMA|UCM|RandomForest"

pre_covid_accuracy_plot(i_x, f_x, by_x, i_y, f_y, by_y, ylab, model_types, accuracy_metrics)

```

```{r, eval=FALSE, echo=FALSE}}
RMdSE_mod1 <- sqrt(colMedians(e1^2, na.rm = TRUE, hasNA = TRUE))
RMdSE_mod2 <- sqrt(colMedians(e2^2, na.rm = TRUE, hasNA = TRUE))
RMdSE_mod3 <- sqrt(colMedians(e3^2, na.rm = TRUE, hasNA = TRUE))

# Zoom in
plot(1:42, RMdSE_mod1, type="l", col=1, xlab="horizon", ylab="RMdSE", ylim = c(0,5000))
lines(1:42, RMdSE_mod2, type="l",col=2)
lines(1:42, RMdSE_mod3, type="l",col=3)
legend("topleft",legend=c("1_RandomForest_noregr","2_RandomForest_regr","3_RandomForest_regr_DUmmy"),col=1:3,lty=1)

```

### MAE

```{r}
MAE_PreCovid <- list()

for (df_name in names(error_df_list_precovid)) {
  # Accedi al dataframe nella lista utilizzando il suo nome
  df <- error_df_list_precovid[[df_name]]
  
  # Applica la funzione di tua scelta al dataframe
  result <- colMeans(abs(df), na.rm = TRUE)
  
  # Assegna il risultato a una variabile con il nome "MAE_nomedeldataframe"
  result_name <- paste0("MAE_", df_name)
  
  MAE_PreCovid[[result_name]] <- result
}
```

```{r}
# Crea una mappa per associare il nome di ogni vettore all'etichetta e al colore desiderati
i_x = 0
f_x = 73
by_x = 10

i_y = 1800
f_y = 4800
by_y = 200
ylab = "MAE"
accuracy_metrics = MAE_PreCovid

model_types = "ARIMA|UCM|RandomForest"

pre_covid_accuracy_plot(i_x, f_x, by_x, i_y, f_y, by_y, ylab, model_types, accuracy_metrics)
```

Valori medi

```{r}
lapply(MAE_PreCovid, mean)
```


#### MAE hold-out

```{r}
MAE_PreCovid_holdout <- list()

for (df_name in names(error_df_list_precovid)) {
  # Accedi al dataframe nella lista utilizzando il suo nome
  df <- error_df_list_precovid[[df_name]]
  
  # Applica la funzione di tua scelta al dataframe
  result <- rowMeans(abs(df["2019-12-12", ]), na.rm = TRUE)
  
  # Assegna il risultato a una variabile con il nome "MAE_nomedeldataframe"
  result_name <- paste0("MAE_", df_name)
  
  MAE_PreCovid_holdout[[result_name]] <- result
}

MAE_PreCovid_holdout
```


### MAPE

```{r}
MAPE_PreCovid <- list()

for (df_name in names(error_percentage_df_list_precovid)) {
  # Accedi al dataframe nella lista utilizzando il suo nome
  df <- error_percentage_df_list_precovid[[df_name]]
  
  # Applica la funzione di tua scelta al dataframe
  result <- colMeans(abs(df), na.rm = TRUE)
  
  # Assegna il risultato a una variabile con il nome "MAPE_nomedeldataframe"
  result_name <- paste0("MAPE_", df_name)
  
  MAPE_PreCovid[[result_name]] <- result
}
```

```{r}
# Crea una mappa per associare il nome di ogni vettore all'etichetta e al colore desiderati
i_x = 0
f_x = 73
by_x = 10

i_y = 10
f_y = 25
by_y = 5
ylab = "MAPE"
accuracy_metrics = MAPE_PreCovid

model_types = "ARIMA|UCM|RandomForest"

pre_covid_accuracy_plot(i_x, f_x, by_x, i_y, f_y, by_y, ylab, model_types, accuracy_metrics)
```


```{r}
MAPE_mod1 <- colMeans(abs(e1_percentage), na.rm = TRUE)
MAPE_mod2 <- colMeans(abs(e2_percentage), na.rm = TRUE)
MAPE_mod3 <- colMeans(abs(e3_percentage), na.rm = TRUE)

plot(1:42, MAPE_mod1, type="l", col=1, xlab="horizon", ylab="MAPE", ylim = c(0,100))
lines(1:42, MAPE_mod2, type="l",col=2)
lines(1:42, MAPE_mod3, type="l",col=3)
legend("topleft",legend=c("1_RandomForest_noregr","2_RandomForest_regr","3_RandomForest_regrDummy"),col=1:3,lty=1)
```

Valori medi

```{r}
lapply(MAPE_PreCovid, mean)
```

#### MAPE hold-out

```{r}
MAPE_PreCovid_holdout <- list()

for (df_name in names(error_percentage_df_list_precovid)) {
  # Accedi al dataframe nella lista utilizzando il suo nome
  df <- error_percentage_df_list_precovid[[df_name]]
  
  # Applica la funzione di tua scelta al dataframe
  result <- rowMeans(abs(df["2019-12-12", ]), na.rm = TRUE)
  
  # Assegna il risultato a una variabile con il nome "MAPE_nomedeldataframe"
  result_name <- paste0("MAPE_", df_name)
  
  MAPE_PreCovid_holdout[[result_name]] <- result
}

MAPE_PreCovid_holdout
```

